# Story 1.2: Implement Auto-Verification MCP Tools

## Status: Done

## Story
As a developer,
I want story completion to automatically trigger verification capture,
so that implementation details and challenges are documented without manual effort.

## Acceptance Criteria
1. New MCP tool `mcp__shrimp-task-manager__auto_verify_bmad_story` detects story completion
2. Tool captures implementation details, technical challenges, and quality scores
3. Verification completes within 30 seconds of story status change
4. Verification data persists and remains accessible through conversational queries

## Dev Notes
**Parallel Work:** Multi-Dev OK
**Reason:** Creates new independent MCP tools and utilities with no shared component modifications

**Technical Context from Architecture:**
- Create new MCP tools in `/src/tools/bmad/` directory
- Implement file system watching using native Node.js fs.watch
- Tools must follow MCP protocol for function registration
- TypeScript strict mode required for all tool implementations
- Use existing Shrimp verification infrastructure where possible

**File Watching Strategy:**
- Monitor `docs/stories/` directory for status changes
- Watch for "Done" or "Ready for Review" status in story files
- Debounce rapid changes (500ms recommended)
- Handle file locks gracefully

**Data Models Required (from architecture/data-models.md):**
```typescript
interface VerificationResult {
  storyId: string;
  score: number;        // 0-100
  summary: string;
  implementationDetails: string[];
  keyAccomplishments: string[];
  technicalChallenges: string[];
  performanceMetrics?: Record<string, any>;
  timestamp: Date;
}
```

## Tasks / Subtasks
- [ ] Task 1: Create file watcher utility (AC: 1)
  - [ ] Implement `/src/utils/file-watcher.ts`
  - [ ] Set up fs.watch on `docs/stories/` directory
  - [ ] Add debouncing logic for rapid changes
  - [ ] Parse story files to detect status changes
- [ ] Task 2: Create auto-verification MCP tool (AC: 1, 2)
  - [ ] Implement `/src/tools/bmad/auto-verify.ts`
  - [ ] Register tool with MCP protocol
  - [ ] Extract story content and context
  - [ ] Trigger verification process
- [ ] Task 3: Implement verification data capture (AC: 2, 3)
  - [ ] Connect to existing Shrimp verification infrastructure
  - [ ] Capture implementation details from story Dev Agent Record
  - [ ] Calculate quality score based on completion criteria
  - [ ] Extract technical challenges from debug log
- [ ] Task 4: Set up data persistence (AC: 4)
  - [ ] Store verification results in `.ai/verification/` directory
  - [ ] Create JSON files with verification data
  - [ ] Index by story ID for quick retrieval
  - [ ] Implement query interface for MadShrimp agent
- [ ] Task 5: Add timeout and error handling (AC: 3)
  - [ ] Implement 30-second timeout for verification
  - [ ] Add graceful fallback for verification failures
  - [ ] Log errors without blocking story completion

## Integration Verification
- [ ] IV1: BMAD story status changes trigger verification without impacting story file integrity
- [ ] IV2: Verification process does not interfere with ongoing BMAD agent operations
- [ ] IV3: Failed verification attempts gracefully fallback without blocking story completion

## Testing
- Test file watching detects story status changes
- Verify auto-verification triggers within 30 seconds
- Test verification data capture and persistence
- Confirm graceful handling of verification failures
- Test query interface for retrieving verification data

## File List
- `/src/utils/file-watcher.ts` - NEW
- `/src/tools/bmad/auto-verify.ts` - NEW
- `/src/types/bmad.ts` - NEW (if not created in Story 1.1)
- `.ai/verification/` - NEW directory for verification data

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
No debug log entries - implementation completed successfully

### Completion Notes
- Created file watcher utility with debouncing for story status changes
- Implemented auto-verification MCP tool with 30-second timeout
- Set up verification data persistence in `.ai/verification/` directory
- Created comprehensive BMAD type definitions
- All verification results stored as JSON with proper error handling

### Change Log
| Date | Change | Author |
|------|--------|--------|
| 2025-09-09 | Created file watcher utility and BMAD types | Claude |
| 2025-09-09 | Implemented auto-verification MCP tool | Claude |
| 2025-09-09 | Added query verification tool for conversational access | Claude |