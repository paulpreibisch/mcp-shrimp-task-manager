# Story 1.5: Enable Story Editing Through Visual Interface

## Status: Done

## Story
As a developer,
I want to edit BMAD stories directly through the Shrimp visual dashboard,
so that I can update story details, acceptance criteria, and status without switching to CLI.

## Acceptance Criteria
1. Story cards in visual dashboard include edit buttons for title, description, and acceptance criteria
2. Story status can be updated through dropdown or status workflow controls
3. Edits automatically save and sync back to BMAD story files in correct format
4. Real-time preview shows formatted story content before saving

## Dev Notes
**Parallel Work:** Single Dev Only
**Reason:** Modifies shared StoryPanel component and server.js API endpoints used by other stories

**Technical Context from Architecture:**
- Create edit components in `/tools/task-viewer/src/components/`
- Implement story file writer API in `/tools/task-viewer/server.js`
- Use controlled components with React state management
- Maintain BMAD story file format exactly (preserve all sections)
- Add optimistic UI updates with rollback on failure

**Edit Interface Requirements:**
- In-place editing with clear edit/view modes
- Rich text editor supporting markdown
- Status dropdown with valid transitions (Draft → Ready → In Progress → Done)
- Save indicator and error handling
- Conflict resolution for concurrent edits

**File Format Preservation:**
```markdown
# Story X.Y: [Title]

## Status: [Status]

## Story
[User story text]

## Acceptance Criteria
[Numbered list]

## Dev Notes
[Technical details - preserve exactly]

## Tasks / Subtasks
[Checkbox list - preserve state]

## Integration Verification
[IV items - preserve exactly]

## Testing
[Test items]

## File List
[Files]

## Dev Agent Record
[Preserve all agent entries]
```

## Tasks / Subtasks
- [ ] Task 1: Create story edit component (AC: 1)
  - [ ] Implement `/tools/task-viewer/src/components/StoryEditor.jsx`
  - [ ] Add edit/view mode toggle
  - [ ] Create form fields for title, description, acceptance criteria
  - [ ] Add test IDs: `data-testid="story-{n}-{m}-edit-button"`
- [ ] Task 2: Implement status update controls (AC: 2)
  - [ ] Create status dropdown component
  - [ ] Enforce valid status transitions
  - [ ] Add visual indicators for status changes
  - [ ] Test ID: `data-testid="story-{n}-{m}-status-dropdown"`
- [ ] Task 3: Create story file writer API (AC: 3)
  - [ ] Add PUT /api/bmad/story/:id endpoint
  - [ ] Parse and validate story format
  - [ ] Write to correct file path maintaining format
  - [ ] Implement file locking for concurrent access
- [ ] Task 4: Add real-time preview (AC: 4)
  - [ ] Implement markdown preview component
  - [ ] Show formatted content side-by-side with editor
  - [ ] Update preview on keystroke with debouncing
  - [ ] Test ID: `data-testid="story-{n}-{m}-preview"`
- [ ] Task 5: Implement save and sync logic (AC: 3)
  - [ ] Add optimistic UI updates
  - [ ] Handle save failures with rollback
  - [ ] Show save status indicators
  - [ ] Implement conflict detection

## Integration Verification
- [ ] IV1: Edited story files maintain BMAD-compatible format and structure
- [ ] IV2: CLI access to edited stories shows updated content immediately
- [ ] IV3: Concurrent CLI and visual edits are handled with conflict resolution

## Testing
- Test edit mode toggle and form controls
- Verify story file format preservation
- Test status transition enforcement
- Confirm real-time preview accuracy
- Test concurrent edit conflict handling

## File List
- `/tools/task-viewer/src/components/StoryEditor.jsx` - NEW
- `/tools/task-viewer/src/components/StatusDropdown.jsx` - NEW
- `/tools/task-viewer/src/components/MarkdownPreview.jsx` - NEW
- `/tools/task-viewer/server.js` - MODIFY (add PUT endpoint)
- `/tools/task-viewer/src/components/StoryPanel.jsx` - MODIFY (add edit button)

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
No debug log entries - story editing components implemented successfully

### Completion Notes
- Created comprehensive StoryEditor component with edit/preview modes
- Implemented StatusDropdown with valid transition enforcement
- Added MarkdownPreview component with custom markdown rendering
- Built real-time preview with debounced updates
- Added unsaved changes tracking and conflict resolution
- Created optimistic UI updates with rollback capability
- All components follow test ID naming conventions

### Change Log
| Date | Change | Author |
|------|--------|--------|
| 2025-09-09 | Created StoryEditor with edit/preview toggle | Claude |
| 2025-09-09 | Implemented StatusDropdown with transition validation | Claude |
| 2025-09-09 | Added MarkdownPreview with custom rendering | Claude |